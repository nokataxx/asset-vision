# 改善Todo リスト

作成日: 2026-01-29

---

## 優先度: 高

### コード品質

- [x] **ESLintエラー修正: button.tsx** ✅ 2026-01-29
  - 箇所: `src/components/ui/button.tsx:62`
  - 対応: `buttonVariants`のエクスポートを削除（内部でのみ使用のため）

- [x] **ESLintエラー修正: regime.ts** ✅ 2026-01-29
  - 箇所: `src/lib/simulation/regime.ts:134`
  - 対応: 未使用パラメータ`_settings`を削除、呼び出し元も修正

### 入力バリデーション

- [x] **資産入力のバリデーション追加** ✅ 2026-01-29
  - 資産額: 0以上、上限10億円（100,000万円）
  - 株式・国債・現金・積立上限それぞれに適用
  - onBlurでクランプ、HTML min/max属性でブラウザバリデーション

- [x] **収支計画のバリデーション追加** ✅ 2026-01-29
  - 成長率: -10%〜+10%の範囲制限
  - シミュレーション期間: 1〜60年に制限
  - 年齢: 0〜120歳、開始年: 1900〜2100年

- [x] **レジーム設定のバリデーション追加** ✅ 2026-01-29
  - 利回り: -100%〜+100%
  - 標準偏差: 0%〜100%
  - 確率: 0%〜100%
  - 国債利回り: -10%〜+20%

- [ ] **バリデーションライブラリ導入検討**
  - Zodなどのスキーマバリデーションで型安全な検証
  - 現状: 軽量な自作バリデーション（src/lib/validation.ts）で対応

### シミュレーションロジック修正

- [x] **回復目標のエッジケース修正** ✅ 2026-01-29
  - 箇所: `src/lib/simulation/regime.ts:110`
  - 修正: `Math.max(0, precrashStocksBalance + netIncome)`で0未満にならないようクランプ
  - 効果: 継続的な赤字でも回復判定が正常に動作

---

## 優先度: 中

### エラーハンドリング

- [x] **Supabaseエラーのユーザー通知** ✅ 2026-02-01
  - 箇所: `src/hooks/useDataPersistence.ts`, `src/App.tsx`
  - 実装: sonnerを使用したトースト通知
  - 保存エラー・読み込みエラー時にユーザーに通知
  - エラー時はローカルストレージにフォールバック

- [x] **オフライン状態の検出と表示** ✅ 2026-02-01
  - 箇所: `src/hooks/useOnlineStatus.ts`, `src/App.tsx`
  - 実装: navigator.onLine + online/offlineイベント監視
  - オフライン時はWifiOffアイコンで状態表示
  - オフライン時はクラウド保存をスキップ、ローカルに自動フォールバック

- [ ] ~~**localStorage容量超過の警告**~~ (スキップ)
  - 理由: 現在のデータサイズ5-10KB、制限5MBの0.1%で問題なし

### 型安全性強化

- [ ] ~~**データ読み込み時の型検証**~~ (延期)
  - 箇所: `src/lib/database/userDataService.ts:48`
  - 現状: `const row = data as UserSimulationDataRow`（検証なしキャスト）
  - 延期理由: リスク低、Zod追加はオーバーキル

### 計算ロジック改善

- [x] **安全引出率（SWR）計算の改善** ✅ 2026-01-29
  - 箇所: `src/lib/simulation/statistics.ts`
  - 修正: 初年度のみ → シミュレーション期間全体の平均取崩し額を使用
  - 効果: 支出成長率がある場合でも実態を反映した引出率を表示

- [x] **50%タイル試行の選択方法改善** ✅ 2026-01-29
  - 表記を「50%タイル試行」→「代表的試行」に変更
  - 選択方法の説明を追加（暴落回数は試行により異なる場合あり）
  - 関数名を`selectMedianTrial`→`selectRepresentativeTrial`に変更

---

## 優先度: 低

### パフォーマンス

- [ ] **モンテカルロシミュレーションの並列化**
  - 現状: 1,000回試行が直列実行（UIブロック100ms+）
  - 改善: Web Workerで並列化
  - 期待効果: 4-8倍の高速化

- [ ] **年次テーブルの仮想化**
  - 現状: 60年以上でDOM性能低下
  - 改善: react-virtualなど導入

- [ ] **バンドルサイズ削減**
  - 現状: 812KB (gzip 239KB)
  - 改善: コード分割、Rechartsの部分インポート
  - 目標: gzip 180KB以下

### 再現性

- [ ] **シード付き乱数生成器の導入**
  - 現状: `Math.random()`使用、シードなし
  - 改善: seedrandomなど導入
  - 効果: シミュレーション結果の再現・検証が可能に

### 自動保存

- [ ] **「今すぐ保存」ボタン追加**
  - 現状: 2秒遅延の自動保存のみ
  - 問題: タブ即閉じでデータ喪失の可能性

- [ ] **保存状態インジケーター追加**
  - クラウドアイコンで保存状態を表示

### ドキュメント

- [ ] **シミュレーションロジックへのコメント追加**
  - `regime.ts`: レジーム遷移ロジックにJSDocコメント
  - `monteCarlo.ts`: 年次処理フローの説明コメント

- [ ] **ARCHITECTURE.md作成（任意）**
  - システム全体のアーキテクチャ説明

### テスト

- [ ] **テストスイート追加**
  - Jest + React Testing Library導入
  - 対象:
    - 回復目標のエッジケース（負の目標値）
    - 0年シミュレーション
    - 初期資産0で支出ありのケース
    - レジーム遷移確率
    - パーセンタイル計算の精度

---

## 枯渇判定の不整合（調査必要）

- [ ] **枯渇判定と表示の整合性確認**
  - `isDepleted()`: `totalAssets <= 0`でチェック
  - 表示: `Math.max(0, balance)`でクランプ
  - 問題: 非枯渇でも資産0表示の可能性
  - 対応: 一貫した丸め処理の適用

---

## 完了項目

### 2026-02-01
- **Supabaseエラーのユーザー通知**: sonnerトースト通知でエラー表示
- **オフライン状態の検出と表示**: useOnlineStatusフック + UIインジケータ

