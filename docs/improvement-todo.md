# 改善Todo リスト

作成日: 2026-01-29

---

## 優先度: 高

### コード品質

- [x] **ESLintエラー修正: button.tsx** ✅ 2026-01-29
  - 箇所: `src/components/ui/button.tsx:62`
  - 対応: `buttonVariants`のエクスポートを削除（内部でのみ使用のため）

- [x] **ESLintエラー修正: regime.ts** ✅ 2026-01-29
  - 箇所: `src/lib/simulation/regime.ts:134`
  - 対応: 未使用パラメータ`_settings`を削除、呼び出し元も修正

### 入力バリデーション

- [x] **資産入力のバリデーション追加** ✅ 2026-01-29
  - 資産額: 0以上、上限10億円（100,000万円）
  - 株式・国債・現金・積立上限それぞれに適用
  - onBlurでクランプ、HTML min/max属性でブラウザバリデーション

- [x] **収支計画のバリデーション追加** ✅ 2026-01-29
  - 成長率: -10%〜+10%の範囲制限
  - シミュレーション期間: 1〜60年に制限
  - 年齢: 0〜120歳、開始年: 1900〜2100年

- [x] **レジーム設定のバリデーション追加** ✅ 2026-01-29
  - 利回り: -100%〜+100%
  - 標準偏差: 0%〜100%
  - 確率: 0%〜100%
  - 国債利回り: -10%〜+20%

- [ ] **バリデーションライブラリ導入検討**
  - Zodなどのスキーマバリデーションで型安全な検証
  - 現状: 軽量な自作バリデーション（src/lib/validation.ts）で対応

### シミュレーションロジック修正

- [x] **回復目標のエッジケース修正** ✅ 2026-01-29
  - 箇所: `src/lib/simulation/regime.ts:110`
  - 修正: `Math.max(0, precrashStocksBalance + netIncome)`で0未満にならないようクランプ
  - 効果: 継続的な赤字でも回復判定が正常に動作

### ランタイム安全性

- [ ] **`Math.max(...array)` スプレッドのスタックオーバーフロー修正**
  - 箇所: `src/lib/simulation/statistics.ts:115,125`
  - 問題: `Math.max(...assets)`でスプレッドにより全要素を引数展開、JSの引数上限（~65k）超過の可能性
  - 修正: `reduce`ベースに変更 → `assets.reduce((a, b) => Math.max(a, b), -Infinity)`

- [ ] **`randomGamma()` の無限ループ防止**
  - 箇所: `src/lib/simulation/regime.ts:51-79`
  - 問題: `while (true)` に反復上限がなく、極端な入力でUIフリーズの可能性
  - 修正: 反復カウンター追加（例: 10,000回で例外スロー）

### エラーバウンダリ

- [ ] **React Error Boundary 導入**
  - 箇所: `src/main.tsx`
  - 問題: 未捕捉エラーで白画面、ユーザーに回復手段がない
  - 修正: `react-error-boundary`導入、フォールバックUIで再読み込みボタンを表示

---

## 優先度: 中

### エラーハンドリング

- [x] **Supabaseエラーのユーザー通知** ✅ 2026-02-01
  - 箇所: `src/hooks/useDataPersistence.ts`, `src/App.tsx`
  - 実装: sonnerを使用したトースト通知
  - 保存エラー・読み込みエラー時にユーザーに通知
  - エラー時はローカルストレージにフォールバック

- [x] **オフライン状態の検出と表示** ✅ 2026-02-01
  - 箇所: `src/hooks/useOnlineStatus.ts`, `src/App.tsx`
  - 実装: navigator.onLine + online/offlineイベント監視
  - オフライン時はWifiOffアイコンで状態表示
  - オフライン時はクラウド保存をスキップ、ローカルに自動フォールバック

- [ ] ~~**localStorage容量超過の警告**~~ (スキップ)
  - 理由: 現在のデータサイズ5-10KB、制限5MBの0.1%で問題なし

### 型安全性強化

- [ ] ~~**データ読み込み時の型検証**~~ (延期)
  - 箇所: `src/lib/database/userDataService.ts:48`
  - 現状: `const row = data as UserSimulationDataRow`（検証なしキャスト）
  - 延期理由: リスク低、Zod追加はオーバーキル

### 計算ロジック改善

- [x] **安全引出率（SWR）計算の改善** ✅ 2026-01-29
  - 箇所: `src/lib/simulation/statistics.ts`
  - 修正: 初年度のみ → シミュレーション期間全体の平均取崩し額を使用
  - 効果: 支出成長率がある場合でも実態を反映した引出率を表示

- [x] **50%タイル試行の選択方法改善** ✅ 2026-01-29
  - 表記を「50%タイル試行」→「代表的試行」に変更
  - 選択方法の説明を追加（暴落回数は試行により異なる場合あり）
  - 関数名を`selectMedianTrial`→`selectRepresentativeTrial`に変更

---

## 優先度: 低

### パフォーマンス

- [ ] **モンテカルロシミュレーションの並列化**
  - 現状: 1,000回試行が直列実行（UIブロック100ms+）
  - 改善: Web Workerで並列化
  - 期待効果: 4-8倍の高速化

- [ ] **年次テーブルの仮想化**
  - 現状: 60年以上でDOM性能低下
  - 改善: react-virtualなど導入

- [ ] **バンドルサイズ削減**
  - 現状: 812KB (gzip 239KB)
  - 改善: コード分割、Rechartsの部分インポート
  - 目標: gzip 180KB以下

### 開発体験

- [ ] **React Fast Refresh の有効化**
  - 箇所: `vite.config.ts:9`
  - 問題: `@vitejs/plugin-react`がコメントアウトされており、HMRでフルリロードが発生
  - 修正: `plugins: [react(), tailwindcss()]`のように両方有効化

### 認証

- [ ] **パスワードリセットの`redirectTo`指定**
  - 箇所: `src/contexts/AuthContext.tsx`
  - 問題: `resetPasswordForEmail`にリダイレクトURLが未指定、デフォルトリダイレクト先が不正確になる可能性
  - 修正: `{ redirectTo: window.location.origin }` を追加

### アクセシビリティ

- [ ] **テーブル操作ボタンの`aria-label`追加**
  - 箇所: `src/components/input/AnnualPlanTable.tsx`
  - 問題: クリアボタンに`aria-label`がなく、スクリーンリーダーが用途を読み上げられない
  - 修正: `aria-label="収入をクリア"`等を各ボタンに追加

- [ ] **装飾アイコンの`aria-hidden`追加**
  - 箇所: 各コンポーネントのlucide-reactアイコン
  - 問題: テキストラベル付き装飾アイコンが読み上げ対象になっている
  - 修正: `aria-hidden="true"`を装飾用アイコンに追加

### 再現性

- [ ] **シード付き乱数生成器の導入**
  - 現状: `Math.random()`使用、シードなし
  - 改善: seedrandomなど導入
  - 効果: シミュレーション結果の再現・検証が可能に

### 自動保存

- [ ] **「今すぐ保存」ボタン追加**
  - 現状: 2秒遅延の自動保存のみ
  - 問題: タブ即閉じでデータ喪失の可能性

- [ ] **保存状態インジケーター追加**
  - クラウドアイコンで保存状態を表示

### ドキュメント

- [x] **シミュレーションロジックへのコメント追加** ✅ 2026-02-13 既存コメントで充足
  - `regime.ts`: 全exported関数にJSDoc、レジーム遷移分岐にインラインコメント済み
  - `monteCarlo.ts`: 年次処理フロー（1〜6ステップ）の説明コメント済み

- [ ] **ARCHITECTURE.md作成（任意）**
  - システム全体のアーキテクチャ説明

### テスト

- [x] **テストスイート追加** ✅ 2026-02-13
  - Vitest導入（4ファイル、53テスト）
  - `regime.test.ts`(19件): 二番底モデル、暴落深さ相関、レジーム遷移全パターン、回復目標エッジケース
  - `withdrawal.test.ts`(15件): 収支処理、枯渇判定、リバランス、現金補填（税率考慮）
  - `monteCarlo.test.ts`(5件): 0年シミュレーション、即枯渇、正常ケース構造検証
  - `statistics.test.ts`(14件): パーセンタイル補間、枯渇確率、安全引出率

---

## 枯渇判定の不整合（調査完了）

- [x] **枯渇判定と表示の整合性確認** ✅ 2026-02-13 問題なし
  - `isDepleted()`: `totalAssets <= 0`でチェック
  - 表示: `Math.max(0, balance)`でクランプ
  - 調査結果: 個別残高が負になるパスは存在しない（processCashFlowで0にリセット、replenishCashはMath.minで制限、株式リターンは±40%にクランプ）
  - 結論: `Math.max(0, ...)`は浮動小数点誤差に対する安全策であり、実質的に不整合は発生しない

---

## 完了項目

### 2026-02-13
- **テストスイート追加**: Vitest導入、シミュレーションコアロジックの53テストを追加
- **枯渇判定と表示の整合性確認**: 調査の結果、問題なしと判断（個別残高が負になるパスなし）
- **シミュレーションロジックへのコメント追加**: 既存コメントで充足していることを確認

### 2026-02-01
- **Supabaseエラーのユーザー通知**: sonnerトースト通知でエラー表示
- **オフライン状態の検出と表示**: useOnlineStatusフック + UIインジケータ

