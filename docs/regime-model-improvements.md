# レジームスイッチングモデル改善案

**作成日**: 2026年2月10日
**ステータス**: Phase 1 実装済み（2026年2月10日）

---

## 1. 背景

現在のシミュレーションでは、シンプルなルールベースのレジームスイッチングモデルを採用している。隠れマルコフモデル（HMM）の完全導入は、過学習リスクやモデルの理解しやすさの観点から見送るが、HMMの考え方を部分的に取り入れることで、より現実的なシミュレーションが可能になる。

### 現在のモデルの特徴

```
通常期 ──(13%確率)──→ 暴落期
   ↑                     │
   │                     ↓ (翌年自動)
   └──(株式残高回復)── 戻り期
```

- **通常期→暴落期**: 固定確率（デフォルト13%）で発生
- **暴落期→戻り期**: 翌年に自動遷移
- **戻り期→通常期**: 株式残高が暴落前水準に回復したら遷移

### HMM完全導入を見送る理由

| 懸念点 | 説明 |
|--------|------|
| 過学習リスク | 金融危機のサンプルは少ない（1928年以降で約12回） |
| 将来≠過去 | 過去を精密にフィットしても将来の市場が同じ構造とは限らない |
| 理解しやすさ低下 | 遷移行列・放出分布はブラックボックス化しやすい |
| 目的との整合性 | 「予測」ではなく「シナリオ分析」が目的 |

---

## 2. 改善案一覧

### 2.1 戻り期の持続期間を確率的にモデル化

**現状の問題:**
- 株式残高が回復目標に達するまで戻り期が続く（決定論的）
- 実際の市場では、完全回復前に次の暴落が来ることもある

**改善案:**

```
戻り期の各年:
  - 確率p1で通常期へ遷移（例: 30%/年）
  - 確率p2で暴落期へ遷移（既存: 13%/年）
  - 残りの確率で戻り期継続
```

**パラメータ案:**

| パラメータ | デフォルト値 | 説明 |
|-----------|-------------|------|
| 戻り期→通常期遷移確率 | 30% | 毎年の通常期への回復確率 |

**根拠:**
- 過去データでは、暴落からの回復期間は1〜5年と幅がある
- 確率30%の場合、平均約3年で通常期に戻る計算

**UI変更:**
- レジーム設定に「戻り期→通常期遷移確率」パラメータを追加
- または内部固定値として実装（UIには表示しない）

---

### 2.2 暴落の深さと回復期間の相関

**現状の問題:**
- 暴落の深さに関わらず、回復ロジックは同じ
- 実際は大暴落ほど回復に時間がかかる傾向

**改善案:**

| 暴落の深さ | 回復期待年数 | 歴史的事例 |
|-----------|-------------|-----------|
| -10%〜-20% | 1〜2年 | 2018年（-4.4%→翌年+31%） |
| -20%〜-35% | 2〜4年 | 2008年（-37%→2013年に回復） |
| -35%超 | 4〜7年 | 1929年（-86%→1954年に回復） |

**実装案:**

```typescript
// 暴落年のリターンに応じて戻り期→通常期遷移確率を調整
function getRecoveryProbability(crashReturn: number): number {
  if (crashReturn > -0.20) return 0.50;  // 軽度: 50%/年
  if (crashReturn > -0.35) return 0.30;  // 中度: 30%/年
  return 0.15;                            // 重度: 15%/年
}
```

---

### 2.3 暴落発生確率の動的調整（オプション）

**現状の問題:**
- 暴落発生確率は毎年固定（13%）
- 実際は暴落が一定期間起きないと「調整」が入りやすい傾向も

**改善案（慎重に検討）:**

```typescript
function getDynamicCrashProbability(yearsSinceLastCrash: number): number {
  const baseProbability = 0.13;
  if (yearsSinceLastCrash >= 10) return 0.18;  // 長期上昇後
  if (yearsSinceLastCrash >= 5) return 0.15;   // やや上昇
  if (yearsSinceLastCrash <= 2) return 0.10;   // 直近暴落後
  return baseProbability;
}
```

**注意:**
- 過学習リスクあり
- 「暴落が起きていないから起きやすい」は必ずしも正しくない
- シンプルさを優先するなら見送り推奨

---

### 2.4 二番底（ダブルディップ）のモデル化

**現状の問題:**
- 戻り期中に再暴落する確率は通常期と同じ（13%）
- 実際は戻り期初期の方が不安定な傾向

**改善案:**

```typescript
function getCrashProbabilityInRecovery(yearsInRecovery: number): number {
  if (yearsInRecovery === 1) return 0.20;  // 1年目: 不安定
  if (yearsInRecovery === 2) return 0.15;  // 2年目: やや不安定
  return 0.13;                              // 3年目以降: 通常と同じ
}
```

**歴史的根拠:**
- 2000-2002年: ITバブル崩壊後に二番底
- 2008-2009年: リーマンショック後に複数回の下落
- 1937年: 大恐慌からの回復途中で再度大幅下落

---

### 2.5 ブートストラップモードの拡張

**現状:**
- S&P 500の過去データからレジーム別にリサンプリング
- 各年は独立してサンプリング

**改善案A: ブロックブートストラップ**

連続する2〜3年をまとめてサンプリングし、レジームの持続性を保持する。

```typescript
// 例: 2年ブロックでサンプリング
const block = selectRandomBlock(historicalData, blockSize: 2);
year1Return = block[0];
year2Return = block[1];
```

**改善案B: レジーム遷移パターンの保持**

暴落→戻りのペアでサンプリングし、実際の回復パターンを再現する。

```typescript
// 暴落年とその後の回復年をペアでサンプリング
const crashRecoveryPair = selectCrashRecoverySequence(historicalData);
// 例: 2008年(-37%) → 2009年(+26%) → 2010年(+15%)
```

---

## 3. 実装優先度

| 改善案 | 効果 | 実装難易度 | 優先度 | 備考 |
|--------|------|-----------|--------|------|
| 2.1 戻り期の確率的遷移 | 高 | 低 | ★★★ | ✅ **実装済み（2026/02/10）** |
| 2.4 二番底モデル | 中 | 低 | ★★☆ | 内部ロジックとして追加 |
| 2.2 暴落深さと回復期間の相関 | 中 | 中 | ★★☆ | 2.1と組み合わせ |
| 2.5 ブロックブートストラップ | 中 | 中 | ★★☆ | ブートストラップモード拡張 |
| 2.3 動的暴落確率 | 低 | 低 | ★☆☆ | 過学習リスクあり、見送り推奨 |

---

## 4. 推奨実装ロードマップ

### Phase 1（短期） ✅ 実装済み

**目標:** 戻り期の確率的遷移を実装

1. ✅ レジーム遷移ロジックを修正
   - 戻り期→通常期: 確率的遷移（優先） OR 株式残高回復（フォールバック）
   - 遷移確率 = 1 / 平均回復年数（例: 2.5年 → 40%/年）

2. ✅ UI変更
   - レジーム設定に「平均回復年数」スライダーを追加（1〜10年、0.5刻み）
   - デフォルト値: 2.5年（S&P500・MSCI ACWI過去実績に基づく）

**実装内容:**
- `src/types/index.ts`: `RegimeSettings` に `averageRecoveryYears` を追加
- `src/lib/simulation/regime.ts`: `determineNextRegime` に確率的遷移を追加
- `src/components/input/RegimeSettingsInput.tsx`: スライダーUIを追加
- `src/lib/validation.ts`: バリデーション制約を追加

**期待効果:**
- 戻り期の持続期間がより現実的な分布になる
- 長期の戻り期（5年以上）も発生しうるシナリオをシミュレート可能

### Phase 2（中期）

**目標:** 二番底リスクと暴落深さの影響を反映

1. 二番底モデルの実装
   - 戻り期1-2年目の暴落確率を上昇

2. 暴落深さと回復期間の相関
   - 暴落年のリターンに応じて遷移確率を調整

**期待効果:**
- 大暴落後の長期低迷シナリオをより現実的にシミュレート
- 2008年型の危機シナリオの再現性向上

### Phase 3（長期）

**目標:** ブートストラップモードの高度化

1. ブロックブートストラップの実装
2. レジーム遷移パターンの保持

**期待効果:**
- 過去データ使用時のレジーム持続性がより現実的に

---

## 5. 検討事項

### モデルの複雑さと理解しやすさのバランス

- パラメータが増えるとユーザーの理解が困難になる
- 一部の改善は内部ロジックとして実装し、UIには表示しない選択肢も

### 過去データの限界

- 金融危機のサンプル数が少ない（約12回）
- パラメータの推定精度には限界がある
- 「25%タイルを基準に計画を立てる」という保守的アプローチは維持すべき

### 後方互換性

- 既存のシミュレーション結果との比較が困難になる可能性
- 改善前後の結果を比較できる仕組みがあると良い

---

## 6. 参考文献

- Hamilton, J. D. (1989). "A New Approach to the Economic Analysis of Nonstationary Time Series and the Business Cycle." Econometrica.
- Ang, A., & Bekaert, G. (2002). "Regime Switches in Interest Rates." Journal of Business & Economic Statistics.
- Guidolin, M., & Timmermann, A. (2007). "Asset allocation under multivariate regime switching." Journal of Economic Dynamics and Control.
