# 要求仕様書：金融資産シミュレーター

**作成日**: 2025年1月19日  
**バージョン**: 2.0

---

## 1. 概要

### 1.1 目的

本アプリケーションは、ユーザーの金融資産（株式、国債、現金）と収支計画を入力し、レジームスイッチングモデルとモンテカルロシミュレーションを組み合わせて将来の資産推移を予測するツールである。

市場の局面（通常期・暴落期・戻り期）を考慮したリアルなシミュレーションにより、資産枯渇リスクや暴落の影響を可視化し、ユーザーの資産計画立案を支援する。

### 1.2 技術スタック

| 項目 | 内容 |
|------|------|
| 言語 | TypeScript |
| フレームワーク | React + Vite |
| スタイリング | Tailwind CSS |
| UIコンポーネント | shadcn/ui |
| 認証 | Supabase Auth（メール/パスワード） |
| データベース | Supabase（PostgreSQL） |
| シミュレーション | クライアントサイドTypeScript |

---

## 2. 画面構成

本アプリケーションは**1画面構成**とする。

### 2.1 メイン画面レイアウト

```
┌─────────────────────────────────────────────────────────────────────────┐
│  金融資産シミュレーター                    [ログイン] or [ユーザー名]  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【入力エリア】                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 🔄 ローカル/クラウドに自動保存              [設定をリセット]    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌───────────────────────┬─────────────────────────────────────────┐   │
│  │  ■ 現在の資産         │  ■ レジーム設定                        │   │
│  │    - 株式・投信       │    - 通常期/暴落期/戻り期の利回り      │   │
│  │    - 国債（残高/上限）│    - 各期の標準偏差                    │   │
│  │    - 現金（残高/上限）│    - 暴落発生確率、国債リターン        │   │
│  │                       │    - 長期期待リターン表示              │   │
│  └───────────────────────┴─────────────────────────────────────────┘   │
│                                                                         │
│  ┌───────────────────────┬─────────────────────────────────────────┐   │
│  │  ■ 収支計画           │  ■ 年次収支テーブル                    │   │
│  │    - 年齢             │    - 年/年齢/収入/支出①/支出②        │   │
│  │    - 開始年/期間      │    - 各年の値を直接編集可能            │   │
│  │    - 収入成長率       │    - 5%/10%/25%/50%タイル表示          │   │
│  │    - 支出成長率       │    - クリアボタン付き                  │   │
│  └───────────────────────┴─────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    [▶ シミュレーション実行]                      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【シミュレーション結果】                                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  ■ 資産推移グラフ（5%〜95%信頼区間、中央値ライン）              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  ■ サマリー指標                                                 │   │
│  │    枯渇確率/期末資産(5%,10%,25%,50%,95%)/平均暴落回数           │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  ■ 年次結果テーブル                                             │   │
│  │    年/年齢/収入/支出①/支出②/資産(5%,10%,25%)/                 │   │
│  │    現金(50%)/国債(50%)/株式(50%)/合計(50%)/資産(95%)            │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

※ 画面幅が狭い場合は縦並びに自動調整（レスポンシブデザイン）

---

## 3. 入力仕様

### 3.1 現在の資産

#### 株式（投資信託）

複数の株式・投資信託を個別に登録可能。シミュレーションでは合算して1つのポートフォリオとして計算する。

| 項目 | 説明 |
|------|------|
| 銘柄名 | 株式・投資信託の名称 |
| 保有額 | 現在の保有額（万円） |

```
■ 株式（投資信託）
┌─────────────────────────┬──────────┬───────────┐
│ 銘柄名                  │ 保有額   │ 操作      │
├─────────────────────────┼──────────┼───────────┤
│ 全世界株式ファンド      │ 5,000万円│ [編集][削除]│
│ 国内株式ファンド        │ 2,000万円│ [編集][削除]│
│ 新興国株式ファンド      │   500万円│ [編集][削除]│
├─────────────────────────┼──────────┼───────────┤
│ 合計                    │ 7,500万円│           │
└─────────────────────────┴──────────┴───────────┘
[+ 銘柄を追加]
```

#### その他資産

| 項目 | 説明 | 単位 | デフォルト値 |
|------|------|------|-------------|
| 国債 | 現在の国債保有額 | 万円 | - |
| 国債積立上限 | 国債残高の上限 | 万円 | 1,000 |
| 現金 | 現在の現金保有額 | 万円 | - |
| 現金積立上限 | 現金残高の上限 | 万円 | 500 |

**積立上限の役割**: シミュレーション中に株式の利益や収支プラス分を配分する際、現金・国債はこの上限を超えて積立されない。上限を超える分は株式に積立される。

#### 基本情報

| 項目 | 説明 | 単位 |
|------|------|------|
| 年齢 | 現在の年齢 | 歳 |

---

### 3.2 収支計画（自動生成＋編集方式）

#### 基本設定

| 項目 | 説明 | デフォルト値 |
|------|------|-------------|
| 開始年 | シミュレーション開始年 | 現在年 |
| シミュレーション期間 | 何年間シミュレーションするか | 30年 |
| 初期収入 | 開始年の年間収入（万円） | - |
| 収入成長率 | 年間収入の成長率（%） | 0% |
| 初期基本生活費 | 開始年の年間基本生活費（万円） | - |
| 基本生活費成長率 | 年間基本生活費の成長率（%）※インフレ考慮 | 1% |

#### 支出の2分類

| 分類 | 説明 | 入力方法 |
|------|------|----------|
| 基本生活費（支出①） | 毎年発生する生活費 | 基本設定で初期値と成長率を設定 |
| 臨時支出（支出②） | 特定年のみ発生する支出 | 年次テーブルで個別に入力 |

#### 年次テーブル（自動生成後、編集可能）

| 列 | 説明 |
|----|------|
| 年 | 対象年 |
| 年齢 | その年の年齢 |
| 収入 | その年の収入 |
| 基本生活費（支出①） | その年の基本生活費 |
| 臨時支出（支出②） | その年の臨時支出（車購入、リフォーム等） |

---

### 3.3 レジーム設定

#### 株式レジームパラメータ

| 項目 | 説明 | デフォルト値 |
|------|------|-------------|
| 通常期利回り | 通常期の年間利回り | 9% |
| 通常期標準偏差 | 通常期のリターンのばらつき | 14% |
| 暴落期利回り | 暴落期の年間利回り | -25% |
| 暴落期標準偏差 | 暴落期のリターンのばらつき | 15% |
| 戻り期利回り | 戻り期の年間利回り | 15% |
| 戻り期標準偏差 | 戻り期のリターンのばらつき | 18% |
| 暴落発生確率 | 1年あたりの暴落発生確率 | 15% |

※上記デフォルト値はS&P 500等の過去実績に基づく現実的な設定。25%タイルを基準に計画を立てることを推奨。

#### レジーム遷移モデル

```
┌─────────────────────────────────────────────────────────┐
│                                                         │
│    ┌────────┐   暴落発生確率    ┌────────┐            │
│    │ 通常期 │ ───────────────→ │ 暴落期 │            │
│    │  +9%   │                   │  -25%  │            │
│    └────────┘                   └────────┘            │
│         ↑                            │                │
│         │                            │ 翌年自動遷移    │
│         │                            ↓                │
│         │   株式残高が回復      ┌────────┐            │
│         └──────────────────── │ 戻り期 │            │
│                                 │  +15%  │            │
│                                 └────────┘            │
│                                                         │
│  ※戻り期中も暴落発生確率で再度暴落期へ遷移する可能性あり │
└─────────────────────────────────────────────────────────┘
```

**戻り期（回復期）の定義**: 暴落期の翌年から、株式残高が暴落直前の水準に回復するまでの期間。回復した時点で通常期に戻る。

#### その他資産のリターン

| 項目 | 説明 | デフォルト値 |
|------|------|-------------|
| 国債リターン | 国債の年間利回り | 1.2% |
| 現金リターン | 現金の年間利回り | 0% |

---

### 3.4 取崩し優先順位（固定ロジック）

取崩し優先順位は経済合理性に基づき固定とする（UIでの変更不可）。

| 局面 | 1位 | 2位 | 3位 | 理由 |
|------|-----|-----|-----|------|
| 通常期 | 株式 | 現金 | 国債 | 成長している株式から利益確定 |
| 暴落期 | 現金 | 国債 | 株式 | 株式の回復を待つため、現金・国債から優先的に取崩す |
| 回復期 | 現金 | 国債 | 株式 | 暴落期と同様、株式の回復を待つ |

※現金・国債が枯渇した場合は、株式から取崩す
※プログラム上は変更可能（`DEFAULT_WITHDRAWAL_PRIORITY`で定義）

---

### 3.5 積立ロジック（固定ルール）

シミュレーション中に資金を積立する場面は2つある。全局面で同じ優先順位で上限を守って積立される。

#### 積立が発生する場面

| 場面 | 説明 |
|------|------|
| 資産リターンの配分 | 国債・株式のリターン（プラスの場合）を各資産に配分 |
| 収支プラス時 | 収入が支出を上回った場合、余剰を各資産に積立 |

#### 積立優先順位（全局面共通）

| 優先順位 | 資産 | 上限 | 理由 |
|---------|------|------|------|
| 1位 | 現金 | 現金積立上限まで | 流動性確保（緊急時に即座に使用可能） |
| 2位 | 国債 | 国債積立上限まで | 安全資産の確保（暴落時・回復期の取崩し原資） |
| 3位 | 株式 | 上限なし | 残りは成長資産へ |

※通常期に現金・国債を上限まで積み立てておくことで、暴落期・回復期のバッファとして機能する

#### 積立ロジック

```
積立処理（積立額、現在残高、上限設定）:

  残り積立額 = 積立額

  1. 現金を上限まで積立
     現金への積立 = min(残り積立額, 現金上限 - 現金残高)
     現金残高 += 現金への積立
     残り積立額 -= 現金への積立

  2. 国債を上限まで積立
     国債への積立 = min(残り積立額, 国債上限 - 国債残高)
     国債残高 += 国債への積立
     残り積立額 -= 国債への積立

  3. 残りは株式へ
     株式残高 += 残り積立額
```

---

### 3.6 過去データ分析（任意機能）

ユーザーが保有する投信等の過去データをCSVでアップロードし、リスク特性を分析する機能。分析結果はレジームパラメータ設定の参考にできる。

#### CSVフォーマット（月次）

| 列名 | 説明 |
|------|------|
| 年月 | YYYY/MM形式（例: 2023/01） |
| リターン | 月次リターン率（%単位、例: 2.3, -1.5） |

#### 算出指標

**■ 基本統計量**

| 指標 | 説明 |
|------|------|
| 年平均リターン | 月次リターンを年率換算した平均値 |
| 年標準偏差 | リターンの年率換算ボラティリティ |
| 最大リターン | 期間中の最高月次リターン |
| 最小リターン | 期間中の最低月次リターン |

**■ リスク指標**

| 指標 | 説明 |
|------|------|
| 最大ドローダウン | 高値から安値までの最大下落率 |
| シャープレシオ | リスクあたりのリターン効率 |
| ソルティノレシオ | 下落リスクあたりのリターン |
| VaR（95%） | 95%の確率で収まる最大損失 |

**■ レジーム分析**

| 指標 | 説明 |
|------|------|
| 暴落頻度 | 閾値以下の下落が発生した頻度 |
| 暴落からの回復期間 | 暴落後に元の水準に戻るまでの平均期間 |
| 局面別平均リターン | 上昇局面/下落局面それぞれの平均 |

#### UI

```
┌─────────────────────────────────────────────────────────┐
│  過去データ分析（任意）                                  │
├─────────────────────────────────────────────────────────┤
│  CSVファイル: [ファイル選択] [分析実行]                  │
│                                                         │
│  ■ 基本統計量                                          │
│  ┌─────────────────────┬────────────┐                  │
│  │ 年平均リターン       │    8.5%    │                  │
│  │ 年標準偏差          │   16.2%    │                  │
│  │ 最大リターン（月次） │   12.3%    │                  │
│  │ 最小リターン（月次） │  -18.5%    │                  │
│  └─────────────────────┴────────────┘                  │
│                                                         │
│  ■ リスク指標                                          │
│  ┌─────────────────────┬────────────┐                  │
│  │ 最大ドローダウン     │  -45.3%    │                  │
│  │ シャープレシオ       │    0.52    │                  │
│  │ ソルティノレシオ     │    0.78    │                  │
│  │ VaR（95%）          │  -12.4%    │                  │
│  └─────────────────────┴────────────┘                  │
│                                                         │
│  ■ レジーム分析                                        │
│  ┌─────────────────────┬────────────┐                  │
│  │ 暴落頻度            │ 約8年に1回  │                  │
│  │ 平均回復期間        │   3.2年    │                  │
│  │ 上昇局面平均        │   14.2%    │                  │
│  │ 下落局面平均        │  -22.5%    │                  │
│  └─────────────────────┴────────────┘                  │
│                                                         │
│  → この投信は市場平均よりややハイリスクです              │
│                                                         │
│  推奨レジーム設定：                                      │
│    通常期: 10%  暴落期: -35%  戻り期: 18%               │
│                                                         │
│  [この値をレジーム設定に反映]                           │
└─────────────────────────────────────────────────────────┘
```

---

## 4. シミュレーション仕様

### 4.1 シミュレーション手法

| 項目 | 仕様 |
|------|------|
| 手法 | レジームスイッチング＋モンテカルロシミュレーション |
| 試行回数 | 1,000回（デフォルト） |
| 時間単位 | 年次 |

### 4.2 シミュレーションロジック

```
各シミュレーション試行（1,000回）:

  初期状態:
    株式残高 = 入力値
    国債残高 = 入力値
    現金残高 = 入力値
    現在レジーム = 通常期
    暴落前株式残高 = 0（回復判定用）

  各年のループ:

    1. レジーム遷移の判定
       ├─ 現在が通常期の場合:
       │    乱数 < 暴落発生確率 → 暴落期へ遷移、暴落前株式残高を記録
       ├─ 現在が暴落期の場合:
       │    → 戻り期へ自動遷移
       └─ 現在が戻り期の場合:
            ├─ 乱数 < 暴落発生確率 → 再度暴落期へ遷移
            └─ 株式残高 ≧ 暴落前株式残高 → 通常期へ遷移

    2. 資産の成長（国債リターンと株式リターンを別々に処理）

       2a. 国債リターンの配分
           国債利益 = 国債残高 × 国債リターン
           → 現金（上限まで）→ 国債（上限まで）→ 株式 の順で配分

       2b. 株式リターンの処理
           株式リターン = 正規分布乱数(レジーム利回り, レジーム標準偏差)
           株式利益 = 株式残高 × 株式リターン
           ├─ 利益 > 0 の場合:
           │    現金（上限まで）→ 国債（上限まで）→ 株式 の順で配分
           └─ 利益 ≦ 0 の場合:
                株式残高から減算

       現金残高は変動なし（リターン0%）

    3. 収支の計算
       年間収支 = 収入 - 基本生活費 - 臨時支出

    4. 取崩し/積立
       ├─ 収支 > 0 の場合:
       │    現金（上限まで）→ 国債（上限まで）→ 株式 の順で積立
       └─ 収支 < 0 の場合:
            取崩し優先順位（通常時/暴落時）に従って取崩し

    5. 枯渇判定
       総資産 ≦ 0 → 枯渇フラグ = true、枯渇年を記録
```

### 4.3 取崩しロジック

```
取崩し処理（取崩し額、優先順位リスト）:

  残り取崩し額 = 取崩し額
  
  優先順位リストの各資産について:
    if 残り取崩し額 > 0:
      実際の取崩し = min(該当資産残高, 残り取崩し額)
      該当資産残高 -= 実際の取崩し
      残り取崩し額 -= 実際の取崩し
  
  return 残り取崩し額  // > 0 なら資金不足
```

---

## 5. 出力仕様

### 5.1 資産推移グラフ

| 要素 | 説明 |
|------|------|
| 中央値ライン | 50%タイルの資産推移 |
| 信頼区間（帯） | 5%〜95%タイルの範囲 |
| 枯渇ライン | 資産0の参照線 |

### 5.2 サマリー指標

| 指標 | 説明 |
|------|------|
| 資産枯渇確率 | シミュレーション期間内に資産が0以下になる確率 |
| 枯渇年の中央値 | 枯渇する場合、何年後に枯渇するかの中央値 |
| 期末資産（5%タイル） | 悲観シナリオの資産額 |
| 期末資産（10%タイル） | やや悲観シナリオの資産額 |
| 期末資産（25%タイル） | 下位25%シナリオの資産額 |
| 期末資産（中央値） | シミュレーション終了時の資産額（50%タイル） |
| 期末資産（95%タイル） | 楽観シナリオの資産額 |
| 暴落発生回数（平均） | 期間中に発生した暴落の平均回数 |

### 5.3 年次テーブル

| 列 | 説明 |
|----|------|
| 年 | 対象年 |
| 年齢 | その年の年齢 |
| 収入 | その年の収入 |
| 支出① | 基本生活費 |
| 支出② | 臨時支出 |
| 資産（5%） | 悲観シナリオの総資産額 |
| 資産（10%） | やや悲観シナリオの総資産額 |
| 資産（25%） | 下位25%シナリオの総資産額 |
| 現金（50%） | 中央値シナリオの現金残高 |
| 国債（50%） | 中央値シナリオの国債残高 |
| 株式（50%） | 中央値シナリオの株式残高 |
| 合計（50%） | 中央値シナリオの総資産額 |
| 資産（95%） | 楽観シナリオの総資産額 |

---

## 6. 認証・データ保存

### 6.1 認証

| 項目 | 仕様 |
|------|------|
| 認証基盤 | Supabase Auth |
| 認証方式 | メール/パスワード |
| 機能 | 新規登録、ログイン、ログアウト、パスワードリセット |

### 6.2 データ保存

| 状態 | 保存先 | 備考 |
|------|--------|------|
| 未ログイン | メモリのみ | ブラウザリロードでデータ消失 |
| ログイン済 | Supabase DB | 永続保存、複数デバイスで共有可能 |

### 6.3 保存データ構造

ユーザーごとに以下のデータを保存する。

**■ 現在の資産**

- 株式（配列）
  - 銘柄名
  - 保有額
- 国債保有額
- 現金保有額
- 年齢

**■ 収支計画**

- 基本設定（開始年、期間、初期収入/支出、成長率）
- 年次テーブル（編集済みの収支データ）

**■ レジーム設定**

- 通常期利回り
- 暴落期利回り
- 戻り期利回り
- 暴落発生確率
- 戻り期継続年数
- 国債リターン
- 現金リターン

---

## 7. バージョンアップ項目（将来対応）

以下の機能は初期バージョンには含めず、将来のバージョンアップで対応する。

| 機能 | 概要 |
|------|------|
| 収支一括変更 | 「〇年以降を一括変更」する機能 |
| OAuth認証 | Google等のソーシャルログイン対応 |
| レジーム内変動幅 | 同じ局面でも年ごとにリターンがブレる設定 |
| 資産配分リバランス | 定期的に資産配分を調整するシミュレーション |

---

## 8. 用語集

| 用語 | 説明 |
|------|------|
| レジームスイッチング | 市場の状態（局面）が切り替わるモデル。通常期・暴落期・戻り期など |
| モンテカルロシミュレーション | 乱数を用いて多数の試行を行い、結果の分布を統計的に分析する手法 |
| ドローダウン | 資産の高値から安値までの下落幅 |
| シャープレシオ | （リターン－無リスク金利）÷ 標準偏差。リスクあたりのリターン効率 |
| ソルティノレシオ | 下落リスク（下方偏差）のみを考慮したリスク調整後リターン |
| VaR（Value at Risk） | 指定した信頼水準で発生しうる最大損失額 |
| パーセンタイル | データを小さい順に並べたときの位置。5%タイルは下位5%の値 |
| 枯渇 | 総資産が0以下になること |

---

## 改訂履歴

| バージョン | 日付 | 内容 |
|-----------|------|------|
| 1.0 | 2025/01/19 | 初版作成 |
| 2.0 | 2025/01/19 | レジームスイッチングモデル採用、画面構成を1画面に変更、支出2分類化、取崩し優先順位設定追加、シナリオ比較機能追加、過去データ分析機能追加 |
| 2.1 | 2025/01/19 | 技術スタック変更（TypeScript + Vite + Tailwind CSS + shadcn/ui） |
| 2.2 | 2025/01/19 | 収支計画のデフォルト値追加（基本生活費成長率: 1%、収入成長率: 0%） |
| 2.3 | 2025/01/19 | 株式（投資信託）を複数銘柄登録可能に変更 |
| 2.4 | 2025/01/22 | シナリオ管理機能を削除（レジーム設定のみでシンプル化） |
| 2.5 | 2025/01/22 | 取崩し優先順位を固定ロジック化（UI削除、経済合理的な順序に変更） |
| 2.6 | 2025/01/24 | レジーム設定に標準偏差を追加、戻り期終了条件を株式残高回復方式に変更、積立時の上限チェックを追加 |
| 2.7 | 2025/01/24 | 画面レイアウトを現在の実装に合わせて更新、年次テーブルに50%タイルの資産内訳を追加、サマリー指標に10%/25%タイルを追加 |
| 2.8 | 2025/01/24 | 資産成長ロジックを修正：国債リターンと株式リターンを別々に処理し、それぞれ現金→国債→株式の順で上限を守って配分（暴落時も国債リターン分は現金に補充） |
| 2.9 | 2025/01/24 | 回復期の取崩し優先順位を暴落期と同様に変更（現金→国債→株式）、戻り期の定義を明確化 |
| 2.10 | 2025/01/24 | レジーム設定デフォルト値を過去実績に基づき調整（通常期9%/14%、暴落期-25%/15%/15%、戻り期15%/18%）、25%タイル基準を推奨 |
