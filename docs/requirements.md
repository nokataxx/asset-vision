# 要求仕様書：金融資産シミュレーター

**作成日**: 2025年1月19日
**バージョン**: 2.22

---

## 1. 概要

### 1.1 目的

本アプリケーションは、ユーザーの金融資産（株式、国債、現金）と収支計画を入力し、レジームスイッチングモデルとモンテカルロシミュレーションを組み合わせて将来の資産推移を予測するツールである。

市場の局面（通常期・暴落期・戻り期）を考慮したリアルなシミュレーションにより、資産枯渇リスクや暴落の影響を可視化し、ユーザーの資産計画立案を支援する。

### 1.2 技術スタック

| 項目 | 内容 |
|------|------|
| 言語 | TypeScript |
| フレームワーク | React + Vite |
| スタイリング | Tailwind CSS |
| UIコンポーネント | shadcn/ui |
| 認証 | Supabase Auth（メール/パスワード） |
| データベース | Supabase（PostgreSQL） |
| シミュレーション | クライアントサイドTypeScript |

---

## 2. 画面構成

本アプリケーションは**1画面構成**とする。

### 2.1 メイン画面レイアウト

```
┌─────────────────────────────────────────────────────────────────────────┐
│  金融資産シミュレーター                    [ログイン] or [ユーザー名]  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【入力エリア】                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 🔄 ローカル/クラウドに自動保存                                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌───────────────────────┬─────────────────────────────────────────┐   │
│  │  ■ 現在の資産[初期値] │  ■ レジーム設定 [初期値]               │   │
│  │    - 株式・投信       │    - 通常期/暴落期/戻り期の利回り      │   │
│  │    - 国債（残高/上限）│    - 各期の標準偏差                    │   │
│  │    - 現金（残高/上限）│    - 暴落発生確率、国債リターン、税率  │   │
│  │                       │    - 長期期待リターン表示              │   │
│  └───────────────────────┴─────────────────────────────────────────┘   │
│                                                                         │
│  ┌───────────────────────┬─────────────────────────────────────────┐   │
│  │  ■ 収支計画  [初期値] │  ■ 年次収支テーブル [初期値]           │   │
│  │    - 年齢             │    - 年/年齢/収入/支出①/支出②        │   │
│  │    - 開始年/期間      │    - 各年の値を直接編集可能            │   │
│  │    - 収入成長率       │    - 75%/50%/25%/10%タイル表示         │   │
│  │    - 支出成長率       │    - クリアボタン付き                  │   │
│  └───────────────────────┴─────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    [▶ シミュレーション実行]                      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  【シミュレーション結果】                                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  ■ 資産推移グラフ（75%/50%/25%/10%タイルライン）               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  ■ サマリー指標                                                 │   │
│  │    成功率/安全引出率/シナリオ別(枯渇年齢,期末,最低)/暴落回数    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  ■ 年次結果テーブル                                             │   │
│  │    年/年齢/収入/支出①/支出②/資産(75%,50%,25%,10%)             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  ■ 50%タイル試行                                                │   │
│  │    年/年齢/レジーム/収入/支出①/支出②/現金/国債/株式/合計      │   │
│  │    ※年次資産推移が50%タイルに最も近い試行を選択して詳細表示    │   │
│  │    ※暴落期は赤背景、戻り期は黄背景で表示                       │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

※ 画面幅が狭い場合は縦並びに自動調整（レスポンシブデザイン）

---

## 3. 入力仕様

### 3.1 現在の資産

| 項目 | 説明 | 単位 | デフォルト値 |
|------|------|------|-------------|
| 株式・投資信託 | 現在の株式・投資信託保有額（合計） | 万円 | 0 |
| うち外貨建て比率 | 株式のうち外貨建て資産の割合 | % | 0 |
| 国債 | 現在の国債保有額 | 万円 | 0 |
| 国債積立上限 | 国債残高の上限 | 万円 | 1,000 |
| 現金 | 現在の現金保有額 | 万円 | 0 |
| 現金積立上限 | 現金残高の上限 | 万円 | 500 |
| 年齢 | 現在の年齢 | 歳 | 30 |

**積立上限の役割**: シミュレーション中に株式の利益や収支プラス分を配分する際、現金・国債はこの上限を超えて積立されない。上限を超える分は株式に積立される。

**外貨建て比率の役割**: 外貨建て株式（海外ETF、外国株式等）の割合を指定する。外貨部分にはレジームに連動した為替変動が適用され、円建ての実質リターンがシミュレーションに反映される。詳細は3.3.6を参照。

---

### 3.2 収支計画

#### 基本設定

| 項目 | 説明 | デフォルト値 |
|------|------|-------------|
| 開始年 | シミュレーション開始年 | 現在年 |
| シミュレーション期間 | 何年間シミュレーションするか | 30年 |
| 収入成長率 | 年間収入の成長率（%） | 0% |
| 基本生活費成長率 | 年間基本生活費の成長率（%） | 0% |

#### 支出の2分類

| 分類 | 説明 | 入力方法 |
|------|------|----------|
| 基本生活費（支出①） | 毎年発生する生活費 | 年次テーブルで入力（成長率で自動計算） |
| 臨時支出（支出②） | 特定年のみ発生する支出 | 年次テーブルで個別に入力 |

#### 年次テーブル

収入・支出を年ごとに直接編集できる。収入または基本生活費を変更すると、それ以降の年に成長率が自動適用される。

| 列 | 説明 |
|----|------|
| 年 | 対象年 |
| 年齢 | その年の年齢 |
| 収入 | その年の収入（変更すると以降の年に成長率適用） |
| 基本生活費（支出①） | その年の基本生活費（変更すると以降の年に成長率適用） |
| 臨時支出（支出②） | その年の臨時支出（車購入、リフォーム等） |

---

### 3.3 レジーム設定

#### 株式レジームパラメータ

| 項目 | 説明 | デフォルト値 |
|------|------|-------------|
| 通常期利回り | 通常期の年間利回り | 14% |
| 通常期標準偏差 | 通常期のリターンのばらつき | 12% |
| 暴落期利回り | 暴落期の年間利回り | -24% |
| 暴落期標準偏差 | 暴落期のリターンのばらつき | 12% |
| 戻り期利回り | 戻り期の年間利回り | 17% |
| 戻り期標準偏差 | 戻り期のリターンのばらつき | 12% |
| 暴落発生確率 | 1年あたりの暴落発生確率 | 12% |
| 平均回復年数 | 戻り期から通常期への平均遷移年数 | 2.5年 |

※上記デフォルト値はS&P 500および全世界株式インデックス（MSCI ACWI）の過去実績に基づく（名目リターン）。25%タイルを基準に計画を立てることを推奨。
※平均回復年数のデフォルト値2.5年はS&P500・MSCI ACWIの過去実績（平均約2.67年）に基づく。

#### リターン分布モデル

株式リターンの生成には**t分布（自由度5）**を使用する。

| 項目 | 仕様 |
|------|------|
| 分布 | t分布 |
| 自由度 | 5（固定） |
| 理由 | 正規分布より裾が厚く、極端な下落（ファットテール）をより現実的にモデル化できる |

**なぜ自由度5か：**
- 学術研究において、株式リターンは自由度4〜8のt分布でよくフィットすることが知られている（Bollerslev 1987他）
- 自由度5は「やや保守的」な設定で、極端なイベントを適度に考慮
- 自由度が小さいほど裾が厚くなり、極端な値が出やすくなる

**正規分布との違い（平均-22%、標準偏差28%の暴落期の例）：**
| 分布 | -50%以下の確率 |
|------|----------------|
| 正規分布 | 約16% |
| t分布（自由度5） | 約22% |

**スケール調整：**
t分布ではスケールパラメータと標準偏差が異なる（t分布の標準偏差 = スケール × √(df/(df-2))）。正規分布と同じ標準偏差を維持しつつ裾だけを厚くするため、スケールパラメータを調整する。

```
調整係数 = √((df-2)/df) = √(3/5) ≈ 0.7746
スケール = 標準偏差 × 調整係数
```

これにより、設定した標準偏差は正規分布と同じ解釈となり、極端な値が出る確率だけが上がる。

**リターンの上限・下限：**
t分布では極端な値が出る可能性があるため、現実的な範囲に制限する。

| 項目 | 値 | 根拠 |
|------|-----|------|
| 上限 | +40% | 歴史的最高+53%（1954年）より保守的に設定 |
| 下限 | -40% | 歴史的最低-43%（1931年）より保守的に設定 |

※自由度・スケール調整・上限下限はUIには表示せず、内部で固定値として使用

#### ブートストラップモード（過去データ使用）

レジーム設定では、従来のパラメータ指定モードに加えて、S&P 500過去実績を使用する**ブートストラップモード**を選択できる。

| モード | リターン生成方法 | 暴落発生確率 |
|--------|-----------------|-------------|
| パラメータ指定 | t分布から生成（平均・標準偏差を指定） | ユーザー指定 |
| 過去データ（S&P 500） | 1928-2024年の実績からランダムサンプリング | 過去実績（約12%） |

**ブートストラップモードの特徴：**
- 分布の仮定なしに、実際に起きたリターンをそのまま使用
- 各レジームのリターンはレジーム別にサンプリング（通常期→通常期の過去データ、暴落期→暴落期の過去データ）
- レジーム遷移ロジック（暴落→戻り期→通常期）は従来通り
- 国債利回り・税率はユーザーが指定

**過去データの統計（1928-2024）：**
| レジーム | 年数 | 平均リターン | 標準偏差 |
|----------|------|-------------|---------|
| 通常期 | 約55年 | 約16% | 約14% |
| 暴落期 | 約12年 | 約-21% | 約11% |
| 戻り期 | 約30年 | 約20% | 約17% |

※ブートストラップモード選択時、入力フォームには過去実績の値が表示され、編集不可となる

#### 歴史的データの根拠

**データソース:**
- [NYU Stern - Historical Returns on Stocks, Bonds and Bills: 1928-2024](https://pages.stern.nyu.edu/~adamodar/New_Home_Page/datafile/histretSP.html)
- [Hartford Funds - 10 Things You Should Know About Bear Markets](https://www.hartfordfunds.com/practice-management/client-conversations/managing-volatility/bear-markets.html)
- [Capital Wealth Advisors - 94 Years of S&P 500 Returns](https://www.capitalwealthadvisors.com/patience-pays-analyzing-94-years-of-sp-500-returns/)
- [LazyPortfolioETF - iShares MSCI ACWI ETF](https://www.lazyportfolioetf.com/etf/ishares-msci-acwi/)

**通常期（正のリターン年）:**
- 発生頻度: 74%（約4年中3年）
- 全期間平均リターン: 約10%（1926年以降）
- インデックス投信の通常期標準偏差: 10-15%（推定）

**暴落期（-10%以上の下落年）:**
- 発生頻度: 12回/94年 = 約13%（約8年に1回）
- 平均リターン: -22.2%
- 主な下落年: 2008年(-37%)、2002年(-22%)、1974年(-26%)、1937年(-35%)、1931年(-43%)

**回復期:**
- ブルマーケット平均年間リターン: +21%（Hartford Funds）
- 最悪の年の後の3年平均リターン: +35%（累計）

#### レジーム遷移モデル

```
┌───────────────────────────────────────────────────────────────┐
│                                                               │
│    ┌────────┐   暴落発生確率    ┌────────┐                  │
│    │ 通常期 │ ───────────────→ │ 暴落期 │                  │
│    │  +10%  │                   │  -22%  │                  │
│    └────────┘                   └────────┘                  │
│         ↑                            │                      │
│         │                            │ 翌年自動遷移          │
│         │                            ↓                      │
│         │   確率的遷移 or       ┌────────┐                  │
│         │   株式残高が回復      │ 戻り期 │                  │
│         └────────────────────  │  +18%  │                  │
│                                 └────────┘                  │
│                                                               │
│  ※戻り期中も暴落発生確率で再度暴落期へ遷移する可能性あり     │
│  ※戻り期初期は再暴落リスクが高い（二番底モデル）             │
│  ※戻り期→通常期は確率的遷移が優先（平均回復年数で制御）     │
│  ※暴落が深いほど回復に時間がかかる（暴落深さ相関）           │
└───────────────────────────────────────────────────────────────┘
```

**通常期の定義**: 市場が正常に機能している期間。平均リターン+10%だが、標準偏差10%により年によって変動する。約16%の確率でマイナスリターンとなるが、これは通常の変動範囲内。

**暴落期の定義**: 年間リターンが-10%以上の下落となる年に相当。歴史的には約8年に1回（13%/年）の頻度で発生し、平均リターンは-22%。S&P 500の1926年以降のデータでは、-10%以上の下落年は94年間で12回発生。

**戻り期（回復期）の定義**: 暴落期の翌年から開始し、以下のいずれかの条件で通常期に戻る：
1. **確率的遷移（優先）**: 毎年、平均回復年数に基づく確率で通常期に遷移（遷移確率 = 1 / 平均回復年数）。例：平均回復年数2.5年の場合、毎年40%の確率で通常期に戻る。ただし、暴落の深さに応じて回復年数が調整される（後述「暴落深さと回復期間の相関」参照）。
2. **残高回復（フォールバック）**: 株式残高が暴落前の回復目標に達した時点で通常期に戻る。回復目標は毎年の収支（収入-支出）に応じて調整される。

**二番底（ダブルディップ）モデル**: 戻り期中の再暴落確率は、回復初期ほど高くなる（内部固定値、UIには表示しない）。

| 戻り期の経過年数 | 暴落確率の乗数 | デフォルト13%の場合 | 根拠 |
|-----------------|---------------|-------------------|------|
| 1年目 | 基本値×1.5 | 約20% | ITバブル崩壊後の二番底（2000-2002年）等 |
| 2年目 | 基本値×1.15 | 約15% | リーマンショック後の不安定期（2008-2009年）等 |
| 3年目以降 | 基本値×1.0 | 13% | 通常の暴落発生確率に収束 |

**暴落深さと回復期間の相関**: 暴落の深さに応じて、平均回復年数に乗数を適用する（内部固定値、UIには表示しない）。

| 暴落の深さ | 回復年数の乗数 | デフォルト2.5年の場合 | 歴史的事例 |
|-----------|---------------|---------------------|-----------|
| 軽度（> -20%） | ×0.6 | 1.5年 | 2018年（-4.4%→翌年+31%で即回復） |
| 中度（-20%〜-35%） | ×1.0 | 2.5年 | 2008年（-37%→2013年に回復） |
| 重度（< -35%） | ×2.0 | 5.0年 | 1929年（-86%→長期回復） |

**平均回復年数の計算例**:
| 平均回復年数 | 遷移確率/年 | 意味 |
|-------------|------------|------|
| 2年 | 50% | 早い回復（楽観シナリオ） |
| 3年 | 33% | 標準的な回復 |
| 5年 | 20% | 遅い回復（悲観シナリオ） |

**回復目標調整の例**: 暴落前残高100万円、毎年10万円の赤字（収入10万、支出20万）の場合
- 1年目の回復目標: 90万円（100万 - 10万）
- 2年目の回復目標: 80万円（90万 - 10万）

#### その他資産のリターン

| 項目 | 説明 | デフォルト値 |
|------|------|-------------|
| 国債リターン | 国債の年間利回り | 1.2% |
| 現金リターン | 現金の年間利回り | 0% |

#### 税率

| 項目 | 説明 | デフォルト値 |
|------|------|-------------|
| 税率 | 株式・国債の取崩し時に適用される税率 | 10% |

取崩し時に税金分を余分に取り崩し、現金には必要額のみ補填される。例：100万円必要、税率10%の場合、110万円を取り崩し、現金に100万円が入る（10万円は税金として消失）。現金からの取崩しは非課税。NISAのみの場合は0%に設定。

#### 為替変動パラメータ（内部固定値）

外貨建て株式に適用される為替変動は、レジームに連動した固定パラメータを使用する。これらの値はUIには表示されない。

| レジーム | 平均リターン | 標準偏差 | 意味 |
|----------|-------------|---------|------|
| 通常期 | 0% | 8% | 中立（円高・円安どちらもあり得る） |
| 暴落期 | -10% | 10% | 円高傾向（リスクオフで円買い） |
| 戻り期 | +5% | 8% | 円安傾向（リスクオンで円売り） |

**為替変動の根拠**:
- 暴落時は「質への逃避」により円が買われやすい（リスクオフ）
- 回復期は投資家のリスク選好が戻り、円が売られやすい（リスクオン）
- 為替リターンは正規分布から生成

**円建て株式リターンの計算式**:
```
円建てリターン = 国内部分 + 外貨部分
  国内部分 = (1 - 外貨比率) × 株式リターン
  外貨部分 = 外貨比率 × ((1 + 株式リターン) × (1 + 為替リターン) - 1)
```

※外貨比率が0%の場合、為替変動は適用されない

---

### 3.4 年間キャッシュフロー処理（固定ロジック）

収支処理は現金を中心に行い、年末に資産間のリバランスを行う。年初に現金を上限まで用意して支出に備え、株安時は株式の売却を避けて現金・国債を有効活用する設計。

#### 処理順序

| 順序 | 処理 | 説明 |
|------|------|------|
| 0 | 年初の現金補充 | 現金を上限まで補充（初年度は国債優先、2年目以降は前年の株式増減で判断） |
| 1 | 収入加算 | 収入を現金に加算 |
| 2 | 支出減算 | 支出を現金から減算 |
| 3 | 現金不足補填 | 現金がマイナスの場合、国債→株式の順で補填 |
| 4 | リターン計算 | 国債・株式のリターンを計算（詳細は3.5参照） |
| 5 | 現金超過リバランス | 現金が上限を超えた分を国債→株式へ移動 |
| 6 | 年末の現金補充 | 現金が上限未満の場合、株式増減に応じて補充 |

#### 年初の現金補充ロジック（ステップ0）

年初に現金を上限まで補充し、年間の支出に備える。

| 条件 | 補填元 | 理由 |
|------|--------|------|
| 初年度 | 国債優先（不足時は株式） | まだ株式増減の実績がないため |
| 2年目以降・前年の株式増減がプラス | 株式優先 | 株高時は株式から利益確定 |
| 2年目以降・前年の株式増減がマイナスまたはゼロ | 国債優先 | 株安時は株式を温存 |

#### 年末の現金補充ロジック（ステップ6）

年末に現金が上限未満の場合、その年の株式増減に応じて補填元を決定する。

| 条件 | 補填元 | 理由 |
|------|--------|------|
| 株式増減がプラス | 株式優先 | 株高時は株式から利益確定 |
| 株式増減がマイナスまたはゼロ | 国債優先 | 株安時は株式を温存 |

※補填は現金が上限に達するまで行う

---

### 3.5 リターン処理ロジック（固定ルール）

#### 国債リターン

国債リターンは国債残高に直接加算される（上限なし）。

#### 株式リターン

| 条件 | 処理 |
|------|------|
| プラスリターン & 国債が上限未達 | 国債に優先積立（上限まで）、残りは株式へ |
| プラスリターン & 国債が上限以上 | 株式に加算 |
| マイナスリターン | 株式から減算 |

※株式のプラスリターンを使って国債を積み増すことで、暴落時のバッファを確保

#### 現金超過リバランス

現金が上限を超えた場合、超過分を以下の順で配分：

| 優先順位 | 配分先 | 条件 |
|---------|--------|------|
| 1位 | 国債 | 国債が上限未達の場合 |
| 2位 | 株式 | 残り全額 |

---

## 4. シミュレーション仕様

### 4.1 シミュレーション手法

| 項目 | 仕様 |
|------|------|
| 手法 | レジームスイッチング＋モンテカルロシミュレーション |
| 試行回数 | 1,000回（デフォルト） |
| 時間単位 | 年次 |

### 4.2 シミュレーションロジック

```
各シミュレーション試行（1,000回）:

  初期状態:
    株式残高 = 入力値
    国債残高 = 入力値
    現金残高 = 入力値
    現在レジーム = 通常期
    暴落前株式残高 = 0（回復判定用）
    戻り期経過年数 = 0（二番底モデル用）
    暴落年リターン = 0（暴落深さ相関用）

  // 年初の現金補充（初年度は国債優先、不足時は株式から）
  現金残高を現金上限まで補充（国債優先）

  各年のループ:

    1. レジーム遷移の判定
       ├─ 現在が通常期の場合:
       │    乱数 < 暴落発生確率 → 暴落期へ遷移、暴落前株式残高を記録
       ├─ 現在が暴落期の場合:
       │    → 戻り期へ自動遷移（戻り期経過年数=1）
       └─ 現在が戻り期の場合:
            // 二番底モデル: 初期ほど再暴落リスク高（1年目×1.5、2年目×1.15）
            調整済み暴落確率 = 暴落発生確率 × 二番底乗数(戻り期経過年数)
            ├─ 乱数 < 調整済み暴落確率 → 再度暴落期へ遷移
            │
            │  // 暴落深さ相関: 深い暴落ほど回復に時間がかかる
            │  調整済み回復年数 = 平均回復年数 × 深さ乗数(暴落年リターン)
            │  遷移確率 = 1 / 調整済み回復年数
            ├─ 乱数 < 遷移確率 → 通常期へ遷移
            ├─ 株式残高 ≧ 暴落前株式残高 → 通常期へ遷移（フォールバック）
            └─ いずれでもない → 戻り期継続（経過年数+1）

    2. 収支処理（現金ベース）
       現金残高 += 収入
       現金残高 -= (基本生活費 + 臨時支出)

       if 現金残高 < 0:
         不足額 = -現金残高
         現金残高 = 0

         // 国債から補填
         国債からの補填 = min(国債残高, 不足額)
         国債残高 -= 国債からの補填
         不足額 -= 国債からの補填

         // 国債で足りなければ株式から補填
         if 不足額 > 0:
           株式からの補填 = min(株式残高, 不足額)
           株式残高 -= 株式からの補填

    3. 資産の成長（リターン計算）

       3a. 国債リターン
           国債利益 = 国債残高 × 国債リターン
           国債残高 += 国債利益  // 国債に直接加算

       3b. 株式リターン（為替変動を含む）
           基本リターン = t分布乱数(レジーム利回り, レジーム標準偏差, 自由度5)
           if 現在レジーム == 暴落期:
             暴落年リターン = 基本リターン  // 暴落深さ相関に使用

           if 外貨建て比率 > 0:
             為替リターン = 正規分布乱数(為替平均, 為替標準偏差)
             国内部分 = (1 - 外貨比率) × 基本リターン
             外貨部分 = 外貨比率 × ((1 + 基本リターン) × (1 + 為替リターン) - 1)
             株式リターン = 国内部分 + 外貨部分
           else:
             株式リターン = 基本リターン

           株式利益 = 株式残高 × 株式リターン

           if 株式利益 > 0 AND 国債残高 < 国債上限:
             // 国債に優先積立
             国債への積立 = min(株式利益, 国債上限 - 国債残高)
             国債残高 += 国債への積立
             株式残高 += (株式利益 - 国債への積立)
           else:
             株式残高 += 株式利益  // マイナスの場合も含む

    4. 年末リバランス（現金超過分の配分）
       if 現金残高 > 現金上限:
         超過分 = 現金残高 - 現金上限
         現金残高 = 現金上限

         // 国債に優先配分
         国債への配分 = min(超過分, 国債上限 - 国債残高)
         国債残高 += 国債への配分
         株式残高 += (超過分 - 国債への配分)

    5. 年末の現金補充（株式増減に応じて）

       if 現金残高 < 現金上限:
         不足額 = 現金上限 - 現金残高

         if 株式利益 ≦ 0:  // 株式が下落または変化なし
           // 国債から優先補填（株式温存）
           国債から補填 → 不足なら株式から補填
         else:
           // 株式から優先補填（利益確定）
           株式から補填 → 不足なら国債から補填

    5.5. 回復目標の調整（暴落期・戻り期のみ）
         年間収支 = 収入 - 基本生活費 - 臨時支出
         暴落前株式残高 += 年間収支
         ※赤字の場合は目標が下がり、黒字の場合は目標が上がる

    6. 枯渇判定
       総資産 ≦ 0 → 枯渇フラグ = true、枯渇年を記録
```

### 4.3 株安時の売り回避設計

本ロジックは以下の仕組みで株安時の株式売却を最小化する：

| 処理 | 株安時の挙動 | 効果 |
|------|-------------|------|
| 年初の現金補充（ステップ0） | 前年の株式増減がマイナスなら国債から補充 | 年間の支出に備えつつ株式を温存 |
| 収支処理（ステップ2-3） | 現金不足時は国債→株式の順で補填 | 株式は最後の手段 |
| 年末の現金補充（ステップ5） | 株式増減がマイナスなら国債から補充 | 株式を温存 |
| 株式リターン（ステップ3b） | 株高時にプラスリターンを国債へ積立 | 暴落時のバッファ確保 |

---

## 5. 出力仕様

### 5.1 資産推移グラフ

| 要素 | 説明 |
|------|------|
| 楽観ライン（緑・破線） | 75%タイルの資産推移 |
| 中央値ライン（青・実線） | 50%タイルの資産推移 |
| 悲観ライン（黄・破線） | 25%タイルの資産推移 |
| 最悪ライン（赤・破線） | 10%タイルの資産推移 |
| 枯渇ライン | 資産0の参照線 |

### 5.2 サマリー指標

#### メイン指標

| 指標 | 説明 |
|------|------|
| 成功率 | シミュレーション期間内に資産が枯渇しない確率（100% - 枯渇確率） |
| 安全引出率（SWR） | 年間取崩し額 ÷ 初期資産。4%以下が目安（4%ルール） |

#### シナリオ別結果（表形式）

| シナリオ | パーセンタイル | 表示項目 |
|----------|--------------|----------|
| 楽観 | 75% | 枯渇時年齢、期末資産、最低到達資産 |
| 中央値 | 50% | 枯渇時年齢、期末資産、最低到達資産 |
| 悲観 | 25% | 枯渇時年齢、期末資産、最低到達資産 |
| 最悪 | 10% | 枯渇時年齢、期末資産、最低到達資産 |

※枯渇時年齢：そのパーセンタイルで資産が枯渇する年齢。枯渇しない場合は「-」
※最低到達資産：各試行で最も資産が少なかった時点の値のパーセンタイル

#### リスク指標

| 指標 | 説明 |
|------|------|
| 暴落回数（平均） | 期間中に発生した暴落の平均回数 |
| 回復期間（平均） | 暴落からの回復にかかる平均年数 |

### 5.3 年次テーブル

各年のパーセンタイル別総資産額を表示する。

| 列 | 説明 |
|----|------|
| 年 | 対象年 |
| 年齢 | その年の年齢 |
| 収入 | その年の収入 |
| 支出① | 基本生活費 |
| 支出② | 臨時支出 |
| 楽観（75%） | 楽観シナリオの総資産額（緑色） |
| 中央値（50%） | 中央値シナリオの総資産額 |
| 悲観（25%） | 悲観シナリオの総資産額（黄色、枯渇時は赤色） |
| 最悪（10%） | 最悪シナリオの総資産額（オレンジ、枯渇時は赤色） |

※各パーセンタイルは年ごとに全試行から独立して計算される

### 5.4 50%タイル試行

1,000回の試行から**年次資産推移が50%タイルに最も近い試行を1つ選択**し、その試行の年次詳細を表示する。選択方法は、各年の資産額と中央値パスとの距離（二乗和）が最小の試行を選ぶ。これにより、年次結果テーブルの50%列と近い推移を示す試行が表示される。レジーム（市場局面）の推移を確認でき、暴落期・戻り期の動作検証に使用できる。

| 列 | 説明 |
|----|------|
| 年 | 対象年 |
| 年齢 | その年の年齢 |
| レジーム | 市場局面（通常/暴落/戻り） |
| 収入 | その年の収入 |
| 支出① | 基本生活費 |
| 支出② | 臨時支出 |
| 現金 | 現金残高 |
| 国債 | 国債残高 |
| 株式 | 株式残高 |
| 合計 | 総資産額 |

**表示上の工夫:**
- 暴落期の行は赤色背景で表示
- 戻り期の行は黄色背景で表示
- ヘッダーに暴落発生回数を表示

※年次テーブル（5.3）とは異なり、1つの試行の全年を通した結果を表示するため、レジームの遷移が追跡可能

---

## 6. 認証・データ保存

### 6.1 認証

| 項目 | 仕様 |
|------|------|
| 認証基盤 | Supabase Auth |
| 認証方式 | メール/パスワード |
| 機能 | 新規登録、ログイン、ログアウト、パスワードリセット |

### 6.2 データ保存

| 状態 | 保存先 | 備考 |
|------|--------|------|
| 未ログイン | localStorage | ブラウザごとにローカル保存 |
| ログイン済 | Supabase DB | 永続保存、複数デバイスで共有可能 |

※ログイン時、localStorageのデータは自動的にSupabase DBに移行される

### 6.3 保存データ構造

ユーザーごとに以下のデータを保存する。

**■ 現在の資産**

- 株式・投資信託保有額
- 外貨建て比率
- 国債保有額
- 国債積立上限
- 現金保有額
- 現金積立上限
- 年齢

**■ 収支計画**

- 基本設定（開始年、期間、成長率）
- 年次テーブル（各年の収入・支出データ）

**■ レジーム設定**

- 通常期利回り/標準偏差
- 暴落期利回り/標準偏差
- 戻り期利回り/標準偏差
- 暴落発生確率
- 国債リターン
- 税率

---

## 7. バージョンアップ項目（将来対応）

以下の機能は初期バージョンには含めず、将来のバージョンアップで対応する。

| 機能 | 概要 |
|------|------|
| OAuth認証 | Google等のソーシャルログイン対応 |
| 資産配分リバランス | 定期的に資産配分を調整するシミュレーション |

---

## 8. モデルの限界・検討事項

本シミュレーションモデルには以下の限界がある。結果を「予測」ではなく「シナリオ分析」として解釈し、安全マージンを持った計画を立てることを推奨する。

### 8.1 現在の限界

| 項目 | 影響 | 対応状況 |
|------|------|----------|
| 手数料未考慮 | 信託報酬等により実際のリターンはやや低くなる | 未対応（影響小） |
| 資産間の相関未考慮 | 暴落時に株式・国債が同時に下落するリスクを過小評価 | 未対応 |
| 為替リスク | 外貨建て資産の為替変動リスク | 一部対応（レジーム連動の簡易モデル） |
| 行動バイアス未考慮 | 暴落時に計画通り行動できない可能性 | 対応不可（人間の問題） |
| 単一の資産クラス | 不動産、金、暗号資産などは対象外 | 未対応 |

### 8.2 実用上の影響度

| 項目 | 影響度 | コメント |
|------|--------|----------|
| 手数料 | 小 | 低コストインデックスファンドなら年0.1%程度 |
| 資産間の相関 | 中 | 国債比率が低ければ影響は限定的 |
| 為替リスク | 中 | レジーム連動の簡易モデルで考慮（独立した為替変動は未対応） |
| 行動バイアス | 大 | モデルでは対応できない最大のリスク |

### 8.3 推奨する使い方

1. **25%タイル（悲観シナリオ）を基準に計画を立てる** - 安全マージンを確保
2. **複数のパラメータ設定で試す** - 楽観/標準/悲観シナリオを比較
3. **定期的に実績と比較して計画を見直す** - 年1回程度の見直しを推奨
4. **インフレは生活費成長率で考慮** - 例：年2%の成長率を設定

### 8.4 レジームモデルの設計判断

#### 隠れマルコフモデル（HMM）完全導入を見送る理由

本シミュレーションではルールベースのレジームスイッチングモデルを採用し、HMMの完全導入は見送っている。

| 懸念点 | 説明 |
|--------|------|
| 過学習リスク | 金融危機のサンプルは少ない（1928年以降で約12回） |
| 将来≠過去 | 過去を精密にフィットしても将来の市場が同じ構造とは限らない |
| 理解しやすさ低下 | 遷移行列・放出分布はブラックボックス化しやすい |
| 目的との整合性 | 「予測」ではなく「シナリオ分析」が目的 |

#### 検討の上見送った改善案

| 改善案 | 概要 | 見送り理由 |
|--------|------|-----------|
| 暴落発生確率の動的調整 | 暴落が一定期間起きないと確率を上昇させる | 過学習リスクあり。「暴落が起きていないから起きやすい」は必ずしも正しくない |
| ブロックブートストラップ | 連続する2〜3年をまとめてサンプリング | Phase 2の暴落深さ相関と効果が重複。暴落イベント数が少なく（S&P 500で12回、MSCI ACWIで3回）シナリオの多様性がかえって低下する |

### 8.5 参考文献

- Hamilton, J. D. (1989). "A New Approach to the Economic Analysis of Nonstationary Time Series and the Business Cycle." Econometrica.
- Ang, A., & Bekaert, G. (2002). "Regime Switches in Interest Rates." Journal of Business & Economic Statistics.
- Guidolin, M., & Timmermann, A. (2007). "Asset allocation under multivariate regime switching." Journal of Economic Dynamics and Control.

---

## 9. 用語集

| 用語 | 説明 |
|------|------|
| レジームスイッチング | 市場の状態（局面）が切り替わるモデル。通常期・暴落期・戻り期など |
| モンテカルロシミュレーション | 乱数を用いて多数の試行を行い、結果の分布を統計的に分析する手法 |
| パーセンタイル | データを小さい順に並べたときの位置。5%タイルは下位5%の値 |
| 枯渇 | 総資産が0以下になること |
| t分布 | 正規分布より裾が厚い確率分布。自由度パラメータで裾の厚さを制御。金融リターンのモデル化に適している |
| ファットテール | 確率分布の裾が厚いこと。極端な値（大暴落など）が正規分布より高い確率で発生する性質 |
| 自由度 | t分布の形状を決めるパラメータ。小さいほど裾が厚くなり、極端な値が出やすくなる |

---

## 改訂履歴

| バージョン | 日付 | 内容 |
|-----------|------|------|
| 1.0 | 2025/01/19 | 初版作成 |
| 2.0 | 2025/01/19 | レジームスイッチングモデル採用、画面構成を1画面に変更、支出2分類化、取崩し優先順位設定追加、シナリオ比較機能追加、過去データ分析機能追加 |
| 2.1 | 2025/01/19 | 技術スタック変更（TypeScript + Vite + Tailwind CSS + shadcn/ui） |
| 2.2 | 2025/01/19 | 収支計画のデフォルト値追加（基本生活費成長率: 1%、収入成長率: 0%） |
| 2.3 | 2025/01/19 | 株式（投資信託）を複数銘柄登録可能に変更 |
| 2.4 | 2025/01/22 | シナリオ管理機能を削除（レジーム設定のみでシンプル化） |
| 2.5 | 2025/01/22 | 取崩し優先順位を固定ロジック化（UI削除、経済合理的な順序に変更） |
| 2.6 | 2025/01/24 | レジーム設定に標準偏差を追加、戻り期終了条件を株式残高回復方式に変更、積立時の上限チェックを追加 |
| 2.7 | 2025/01/24 | 画面レイアウトを現在の実装に合わせて更新、年次テーブルに50%タイルの資産内訳を追加、サマリー指標に10%/25%タイルを追加 |
| 2.8 | 2025/01/24 | 資産成長ロジックを修正：国債リターンと株式リターンを別々に処理し、それぞれ現金→国債→株式の順で上限を守って配分（暴落時も国債リターン分は現金に補充） |
| 2.9 | 2025/01/24 | 回復期の取崩し優先順位を暴落期と同様に変更（現金→国債→株式）、戻り期の定義を明確化 |
| 2.10 | 2025/01/24 | レジーム設定デフォルト値を過去実績に基づき調整（通常期9%/14%、暴落期-25%/15%/15%、戻り期15%/18%）、25%タイル基準を推奨 |
| 2.11 | 2025/01/24 | 50%タイル試行テーブルを追加（レジーム推移を確認可能）、年次結果テーブルを総資産のみに簡素化 |
| 2.12 | 2025/01/24 | 仕様書を実装に合わせて更新：株式を単一値に変更、収支計画から初期収入/生活費を削除（年次テーブルで直接入力方式）、基本生活費成長率デフォルトを0%に変更、未ログイン時のデータ保存をlocalStorageに変更、過去データ分析機能を削除 |
| 2.13 | 2025/01/24 | 戻り期の回復目標を収支考慮方式に変更：毎年の収支（収入-支出）に応じて回復目標を調整（赤字なら目標低下、黒字なら目標上昇） |
| 2.14 | 2025/01/25 | サマリー指標を刷新（成功率/安全引出率/シナリオ別表形式）、パーセンタイルを75%/50%/25%/10%に統一、レジーム設定デフォルト値を過去実績に基づき調整（通常期10%/13%、暴落期-30%/28%、戻り期18%/22%）、50%タイル試行の選択方法を年次パス距離最小方式に変更、参照値ツールチップ追加 |
| 2.15 | 2026/01/25 | レジーム設定デフォルト値をS&P 500/MSCI ACWIの歴史的データに基づき再調整（通常期10%/10%、暴落期-22%/28%/13%、戻り期18%/20%）、参照値ツールチップを削除、歴史的データの根拠を追記 |
| 2.16 | 2026/01/31 | 取崩しロジックを刷新：収支処理を現金ベースに変更（収入→現金加算、支出→現金減算、不足時は国債→株式から補填）、株式プラスリターンを国債に優先積立、年末に下落率に応じた現金補填（閾値以下なら国債優先で株式温存、閾値超なら株式から利益確定） |
| 2.17 | 2026/01/31 | 下落閾値設定を削除、現金補填ロジックをシンプル化（下落率0%以下→国債優先、0%超→株式優先） |
| 2.18 | 2026/02/01 | ブートストラップモード追加：レジーム設定でS&P 500過去実績（1928-2024）からのリサンプリングを選択可能に、資産推移グラフにパーセンタイル表示のチェックボックス追加 |
| 2.19 | 2026/02/01 | 為替変動リスク機能追加：株式の外貨建て比率を入力可能に、レジーム連動の為替変動（通常期0%/8%、暴落期-10%/10%、戻り期+5%/8%）を円建てリターンに反映 |
| 2.20 | 2026/02/10 | 平均回復年数パラメータ追加：戻り期→通常期の確率的遷移を実装（遷移確率=1/平均回復年数）、スライダーで1〜10年の範囲で0.5刻みで調整可能、デフォルト2.5年（S&P500・MSCI ACWI過去実績に基づく） |
| 2.21 | 2026/02/13 | 二番底モデルと暴落深さ相関を追加：戻り期初期の再暴落確率を上昇（1年目×1.5、2年目×1.15）、暴落の深さに応じて回復年数を調整（軽度×0.6、中度×1.0、重度×2.0）。いずれも内部ロジックとして実装（UI変更なし） |
| 2.22 | 2026/02/19 | 現金補充ロジックを改善：年初に現金を上限まで補充する処理を追加（初年度は国債優先、2年目以降は前年の株式増減で判断）、年末の現金補充の判断基準を総資産変動率から株式増減に変更（株式プラス→株式から補充、マイナス→国債から補充） |
