# ビジネスロジック改善提案

作成日: 2026-02-20

---

## 影響度: 大

### 1. インフレが実質的にモデル化されていない

- **箇所**: `src/lib/annualPlan.ts`, `src/lib/simulation/monteCarlo.ts`
- **現状**: `incomeGrowthRate`と`expenseGrowthRate`は定義されているが、年次テーブルUIでセルを編集した際の「以降の年の自動計算」にしか使われていない。シミュレーションエンジン自体はインフレを考慮しない
- **問題**: 30年シミュレーションで年2%のインフレがあると実質的な支出は倍になるが、デフォルトでは名目固定のまま。**長期シミュレーションで最も楽観バイアスを生む要因**
- **改善案**: シミュレーション実行時に成長率を自動適用するオプション、または「インフレ未考慮」の警告表示

### 2. 税金が元本込みの全額にかかっている

- **箇所**: `src/lib/simulation/withdrawal.ts` (`replenishCash`)
- **現状**: 取崩し額全体に `taxMultiplier = 1 + taxRate/100` を適用。例：100万円取崩し、税率20% → 120万円を売却し100万円が現金に入る
- **問題**: 現実には税金は**売却益（キャピタルゲイン）部分のみ**に課税される。含み益率50%の株式100万円売却 → 実際の課税は50万円×20%=10万円だが、現モデルでは100万円×20%=20万円を徴収。**シミュレーションを必要以上に悲観的**にしている
- **改善案**: 含み益率（簿価追跡）を導入し、利益部分のみに課税する方式に変更

### 3. 国債リターンが完全に確定的（ボラティリティゼロ）

- **箇所**: `src/lib/simulation/monteCarlo.ts:68`
- **現状**: 国債リターンは毎年固定の1.2%。ボラティリティなし、レジーム連動なし
- **問題**: 実際には国債にも価格変動がある。暴落時には「安全資産への逃避」で国債価格が上昇する傾向、インフレ環境では実質リターンがマイナスになりうる。国債比率が高いポートフォリオで現実とのズレが大きい
- **改善案**: レジーム連動の国債リターンモデル導入（例：通常期1.2%、暴落期3%、戻り期1.5%）＋ 小さなボラティリティ

---

## 影響度: 中

### 4. 暴落期が常に1年間

- **箇所**: `src/lib/simulation/regime.ts` レジーム遷移ロジック
- **現状**: 暴落期は必ず翌年に戻り期へ遷移する（1年固定）
- **問題**: 歴史的には複数年にわたる暴落が存在する（1930-1931年、1973-1974年、2001-2002年）。二番底モデルで部分的にカバーしているが、「暴落→回復→再暴落」と「2年連続暴落」は性質が異なる
- **改善案**: 暴落継続確率パラメータの導入（例：翌年も暴落が続く確率30%）

### 5. 為替変動リスクモデルの限界

現在の為替モデル（`src/lib/simulation/regime.ts` `FX_PARAMS` / `getFxReturn` / `getEffectiveStockReturn`）はレジーム連動の基本設計は正しいが、以下の限界がある。

#### 5a. 株式リターンと為替リターンの相関が未考慮

- **現状**: 株式リターンと為替リターンは独立した乱数で生成
- **問題**: リスクオフ時に「株安＋円高」が同時に起きる傾向があり、外貨比率が高いポートフォリオではテールリスクを過小評価する可能性
- **改善案**: コレスキー分解による相関付き乱数生成。レジーム別の相関係数を設定（例：暴落期 ρ=-0.5 = 株安と円高が同方向、通常期 ρ=-0.2）

#### 5b. 為替リターンが正規分布（株式はt分布）

- **現状**: `getFxReturn`は`randomStandardNormal()`で正規分布を使用。一方、株式リターンはt分布（自由度5）でファットテールを表現
- **問題**: 為替にも急激な変動（通貨危機、フラッシュクラッシュ等）が存在し、正規分布では過小評価される。モデル間の一貫性も欠ける
- **改善案**: 為替リターンにもt分布を適用（自由度は株式より大きめの8程度が妥当）

#### 5c. FXパラメータがハードコードで調整不可

- **現状**: `FX_PARAMS`は内部固定値（通常期0%/8%、暴落期-10%/10%、戻り期+5%/8%）。ユーザーは変更できない
- **問題**: 為替ヘッジ付き外国ファンドを保有するユーザーはFXボラティリティを0にしたいが手段がない。また、自分の為替見通しを反映できない
- **改善案**: 「為替ヘッジあり」チェックボックスの追加（ONでFX変動を無効化）。上級者向けにFXパラメータの表示・編集オプションも検討

#### 5d. 暴落時の円高仮定（mean: -10%）が常に成立するとは限らない

- **現状**: 暴落期は常にFX mean=-10%（円高方向）
- **問題**: 2022年は株式下落にもかかわらず日米金利差拡大で大幅な円安。暴落の原因（金融危機 vs 金利上昇 vs 地政学リスク）によって為替の反応は異なる
- **備考**: 完全なモデル化は困難。現在の仮定は「リスクオフ＝円高」という伝統的な傾向に基づいており、多くのケースでは妥当。ただし万能ではないことをユーザーが理解できる説明があると良い

#### 5e. 長期的な為替の平均回帰が未考慮

- **現状**: 為替リターンは毎年独立に生成（i.i.d.）
- **問題**: 30年以上のシミュレーションで、累積的に極端な円高/円安（例：1ドル=30円や500円）になる試行が発生しうる。実際には購買力平価（PPP）に回帰する傾向がある
- **改善案**: 累積為替変動に対する平均回帰項の導入（例：累積変動が±30%を超えたら逆方向へのドリフトを追加）、または累積変動の上下限クランプ

### 6. 株式プラスリターンの国債優先積立が複利効果を減殺

- **箇所**: `src/lib/simulation/monteCarlo.ts:85-93`
- **現状**: 株式のプラスリターンは国債が上限に達するまで国債に回される
- **問題**: 暴落時のバッファ確保として合理的だが、好況が続く場合に株式の複利効果を大きく減殺する
- **改善案**: 国債への自動積立額に年間上限を設ける、または積立割合をユーザーが調整可能にする

---

## 影響度: 低〜中

### 7. ACWIブートストラップの暴落サンプルが4つしかない

- **箇所**: `src/data/msci-acwi-historical.ts`
- **現状**: ACWIの暴落期データは `[-16.21, -19.32, -42.19, -18.37]` の4値のみ
- **問題**: サンプルが少なすぎるため、ブートストラップの意義（分布の仮定を置かない）が薄れる
- **改善案**: ACWI暴落サンプルが少ない旨のUI上の注意表示、またはS&P 500データでの補完オプション

### 8. 暴落深さ相関がステップ関数

- **箇所**: `src/lib/simulation/regime.ts` (`getCrashDepthRecoveryMultiplier`)
- **現状**: 3段階の閾値（-20%, -35%）で回復年数乗数を切り替え（0.6 / 1.0 / 2.0）
- **問題**: -19.9%と-20.1%で回復速度が大きく変わる不連続性
- **改善案**: 線形補間による滑らかな乗数計算

### 9. 収支処理が年初一括でリターン計算前に実行される

- **箇所**: `src/lib/simulation/monteCarlo.ts` 年次処理順序
- **現状**: 収支処理（ステップ2）がリターン計算（ステップ3）の前に実行される。年間の支出全額がリターン適用前に差し引かれる
- **問題**: 実際には支出は年間を通じて分散し、ポートフォリオは年間を通じてリターンを生む。現モデルはポートフォリオを若干不利に扱う
- **改善案**: 支出の半分を年初、半分を年末に適用する半年ステップモデル

### 10. 枯渇後もシミュレーションが継続する

- **箇所**: `src/lib/simulation/monteCarlo.ts` 枯渇判定
- **現状**: 総資産≦0で枯渇フラグを立てるが、シミュレーションは継続する。後年に収入が支出を上回る場合、資産が「復活」する可能性がある
- **問題**: 枯渇後の復活は現実的にはあり得るが（年金収入など）、ユーザーの意図と異なる場合がある
- **改善案**: 枯渇後の処理について「継続」「停止」の選択肢をユーザーに提供

---

## 優先実装順序（推奨）

| 順位 | 項目 | 理由 |
|------|------|------|
| 1 | インフレモデル (#1) | 長期シミュレーションの信頼性に最も影響 |
| 2 | 税金計算の修正 (#2) | 含み益率の概念導入で精度が大幅向上 |
| 3 | 国債リターンへのレジーム連動 (#3) | 比較的小さな変更で現実性が向上 |
| 4 | 暴落深さ相関の線形補間 (#8) | 小さな変更で不連続性を解消 |
| 5 | 為替ヘッジオプション (#5c) | UI変更のみで実用的価値が高い |
| 6 | 株式・為替相関 (#5a) | 外貨比率の高いユーザーへの影響大 |
| 7 | 暴落継続期間モデル (#4) | レジームモデルの現実性向上 |
| 8 | 為替の平均回帰 (#5e) | 長期シミュレーションの極端なケースを抑制 |
